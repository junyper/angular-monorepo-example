{"version":3,"file":"test-utils.js","sources":["../../src/lib/render.ts","../../src/lib/debug.ts","../../src/lib/screenshot.ts","../../src/public-api.ts","../../src/test-utils.ts"],"sourcesContent":["import { Component } from '@angular/core';\nimport { configure, render as _render } from '@testing-library/angular';\n\nconfigure({\n  defaultImports: [],\n});\n\n@Component({ selector: 'test-fixture', template: '' })\nclass Fixture {}\n\nexport const render =  (...args) => {\n  const [ first, second ] = args;\n  if (typeof first === 'function') {\n    return _render(first, { excludeComponentDeclaration: true, ...second });\n  } else {\n    return _render(Fixture, first);\n  }\n}\n","\nimport prettyFormat from 'pretty-format';\n\nconst { DOMElement, DOMCollection } = prettyFormat.plugins;\n\nconst prettyDOM = (htmlElement, maxLength?, options?) => {\n  if (htmlElement.documentElement) {\n    // eslint-disable-next-line no-param-reassign\n    htmlElement = htmlElement.documentElement;\n  }\n\n  const debugContent = prettyFormat(\n    htmlElement,\n    Object.assign(\n      {\n        plugins: [DOMElement, DOMCollection],\n        printFunctionName: false,\n        highlight: true\n      },\n      options\n    )\n  );\n  return maxLength !== undefined && htmlElement.outerHTML.length > maxLength\n    ? `${debugContent.slice(0, maxLength)}...`\n    : debugContent;\n};\n\n// eslint-disable-next-line no-console\nconst debug = (el = document, maxLength?, options?) => console.log(prettyDOM(el, maxLength, options));\n\nexport { debug };\n","\nimport { join } from 'path';\nimport { outputFileSync } from 'fs-extra';\nimport { AddressInfo } from 'net';\nimport http from 'http';\nimport connect from 'connect';\nimport finalhandler from 'finalhandler';\nimport puppeteer from 'puppeteer';\nimport { percySnapshot } from '@percy/puppeteer';\nimport 'dotenv/config';\n\nimport { debug } from './debug';\n\nconst createServer = async html => {\n  const app = connect();\n  app.use(\n    (request, response, next) =>\n      request.url === '/' ? response.end(html) : next()\n  );\n  app.use(finalhandler);\n  const server = http.createServer(app);\n  await new Promise((resolve, reject) => {\n    const startServer = () => {\n      server.once('error', (e: any) => {\n        if (e.code === 'EADDRINUSE') server.close(startServer);\n      });\n      server.listen(0, resolve);\n      server.on('error', reject)\n    };\n    startServer();\n  });\n  return server;\n};\n\nconst generateImage = async (url, fileName, options) => {\n  // Options see:\n  // https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md#puppeteerlaunchoptions\n  const browser = await puppeteer.launch({\n    executablePath: process.env.PUPPETEER_EXECUTABLE_PATH || '/Applications/Google Chrome.app/Contents/MacOS/Google Chrome',\n    // devtools: true,\n    // dumpio: true,\n    args: [\n      '--no-sandbox',\n      '--disable-lcd-text',\n      '--disable-setuid-sandbox',\n      '--disable-background-timer-throttling',\n      '--disable-backgrounding-occluded-windows',\n      '--disable-renderer-backgrounding',\n      '--disable-infobars',\n      '--disable-web-security',\n      '--no-default-browser-check',\n      '--use-mock-keychain',\n      '--no-first-run',\n      '--disable-default-apps',\n      '--disable-popup-blocking',\n      '--disable-translate',\n      '--disable-extensions',\n      '--use-fake-ui-for-media-stream',\n      '--use-fake-device-for-media-stream',\n      '--allow-file-access-from-files',\n    ],\n  });\n  const page = await browser.newPage();\n  await page.goto(\n    url,\n    { waitUntil: 'networkidle0' }\n  );\n\n  if (process.env.CI) {\n    await percySnapshot(page, fileName, options)\n  } else {\n    const image = await page.screenshot(options);\n    outputFileSync(join(process.cwd(), `__screenshots__/${fileName}.png`), image);\n  }\n\n  browser.close();\n};\n\nconst SCREENSHOTS = {};\nconst getImageFileName = () => {\n  const state = expect.getState();\n  const testName = state.currentTestName;\n  if (SCREENSHOTS[testName]) {\n    SCREENSHOTS[testName]++;\n  } else {\n    SCREENSHOTS[testName] = 0;\n  }\n  const index = SCREENSHOTS[testName];\n  return `${state.currentTestName}${index > 0 ? index : ''}`;\n}\n\nconst screenshot = async (options = { debug: true }) => {\n  if (options.debug) debug(document);\n\n  const fileName = getImageFileName();\n  const html = document.documentElement.outerHTML;\n  const server = await createServer(html);\n  const { port } = server.address() as AddressInfo;\n  const url = `http://localhost:${port}`;\n\n  await generateImage(url, fileName, options);\n  await new Promise(resolve => server.close(resolve));\n};\n\nexport { screenshot };\n","/*\n * Public API Surface of test-utils\n */\n\nimport { screen, fireEvent, waitFor } from '@testing-library/angular';\nimport { axe } from 'jest-axe';\n\nimport { render } from './lib/render';\nimport { screenshot } from './lib/screenshot';\n\ndeclare global {\n  namespace jest {\n    interface Matchers<R> {\n      toHaveNoViolations(options?: unknown): R;\n    }\n  }\n}\n\nexport {\n  render,\n  screenshot,\n  screen,\n  fireEvent,\n  axe,\n  waitFor\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":["_render"],"mappings":"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"}